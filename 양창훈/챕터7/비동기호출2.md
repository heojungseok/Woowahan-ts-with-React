# API 에러 핸들링

비동기 API 호출을 하다보면 상태 코드에 따라 401,404,500 등 다양한 에러가 발생할 수 있따.
타입스크립트에서는 어떻게 이러한 에러를 어떻게 처리하고 명시할 수 있을까.

## 타입 가드 활용하기

Axios 라이브러리에서는 Axios 에러에 대해 isAxiosError라는 타입 가드를 제공하고 잇다.

```ts
interface ErrorResponse {
  status: string;
  serverDateTime: string;
  errorCode: string;
  errorMessage: string;
}

function isServerError(error: unknown): error is AxiosError<ErrorResponse> {
  return axios.isAxiosError(error);
}

const onClickDeleteHistoryButton = async (id: string) => {
  try {
    await axios.post('URL', { id });
    alert('주문내역 삭제');
  } catch (e: unknown) {
    // 에러가 Axios 에러이며 ErrorResponse의 형태를 지니고 있고, 서버 응답이 존재하며, 그 응답에는 errorMessage 속성이 존재하는 경우
    if (isServerError(e) && e.response && e.response.data.errorMessage) {
      // true일 경우 명시적으로 서버 에러를 처리하고 에러 메시지를 설정
      setErrorMessage(e.response.data.errorMessage);
    }
    // false일 경우 일반적인 일시적인 에러 메시지를 설정
    setErrorMessage('일시적인 에러가발생했습니다. 잠시 후 다시 시도해주세요');
  }
};
```
타입 가드를 활용하면 서버에러를 명시적으로 확인할 수 있다.

## 에러 서브 클래싱 하기
요청을 처리할 때 단순 서버 에러 뿐만 아니라 인증, 네트워크, 타임아웃 등 다양한 에러가 발생할 수 있다. 이를 더욱 명시적으로 표시하기 위해 서브클래싱을 활용할 수 있다.

**서브클래싱: 기존 클래스를 확장하여 새로운 하위 클래스를 만드는 과정. 새로운 클래스는 상위 클래스의 모든 속성과 메서드를 상속받아 사용할 수 있고 추가적인 속성과 메서드를 정의할 수 있다.**

```ts
const getOrderHistory = async (page:number) => Promise<History> {
  try {
    const data = await axios.get("APIURL");
    const history = await JSON.parse.(data);
    } catch (e) {
      alert(e.message)
    }
  }
```


## 인터셉터를 활용한 에러 처리

Axios 같은 페칭 라이브러리는 인터셉터기능을 제공한다. 이를 사용하면 HTTP 에러 일관된 로직을 적용할 수 있다.

```ts
const httpErrorHandler = (
  error: AxiosError<ErrorResponse> | Error
): Promise<Error> => {
  // AxiosError일 때만 response가 있음
  if (axios.isAxiosError(error)) {
    const status = error.response?.status;

    // 🔥 토큰 만료 (401)
    if (status === 401) {
      window.location.href = '/login';
    }

    // 🔥 서버 장애 (500)
    if (status === 500) {
      alert('서버 오류가 발생했습니다.');
    }
  }

  // 반드시 reject를 반환해야 후속 에러 처리가 가능함
  return Promise.reject(error);
};

orderApiRequester.interceptors.response.use(
  (response: AxiosResponse) => response,
  httpErrorHandler
);
```
인터셉터를 사용하면 모든 API 에러를 한 곳에서 처리할 수 있고,
401, 500 같은 공통 동작도 자동으로 처리됨.

# API모킹

서버API가 완성되기 전 원활한 프론트엔드 개발을 위한 가짜서버,모킹을 활용한다

## json파일 불러오기
```ts
const SERVICES: Service[] = [
  {
    id: 0,
    name: '우아한',
  },
  {
    id: 1,
    name: '형제들',
  },
];

export default SERVICES;

//api
const getServices = ApiRequest.get("/mock/service.ts");
간단한 조회만 필요한 경우에는 *.json 파일을 만들거나 자바스크립트 파일 안에 JSON형식의 정보를 저장하고 익스포트 하는 방식을 사용하면 된다.

이후 get요청에 파일 경로를 삽입해주면 조회 응답으로 원하는 값을 받을 수 있다.

```


## API 요청 핸들러에 분기 추가하기

```ts

const mockFetchBrans =() =>{}

const fetchBrands = () => {
  if (useMock) {
    // 목업데이터를 fetch하는 함수
    return mockFetchBrands();
  }
  // 서버에서 API 호출
  return requester.get('/brands');
};
```

위 방은 개발이 완료된 이후에도 유지보수할 때 목업 함 수를 사용할 수 있다.
서버의존도 x 그러나 모든 api 여ㅛ청 함수에 if 분기문을 추가해야 하므로 번거롭게 느껴질 수도 있다.


## axios-mock-adapter로 모킹하기

위 함수처럼 분기문이 추가되는 것을 바라지 않는다면 라이브러리를 사용하면된다.
axios-mock-adaptor는ㄴ Axios 요청을 가로채서 요청에 대한 응답 값을 대신 반환한다.

앞에 두가지 방법과 다르게 mock API의 주소가 필요하지 않는다.

```ts
import axios from 'axios';
import MockAdapter from 'axios-mock-adapter';

// 1. axios 인스턴스 가져오기
const mock = new MockAdapter(axios);

// 2. 어떤 요청에 어떤 응답을 줄지 정의
mock.onGet('/users').reply(200, {
  users: [{ id: 1, name: 'Alice' }]
});

// 3. axios 요청
axios.get('/users').then(res => {
  console.log(res.data);  
  // { users: [{ id: 1, name: 'Alice' }] }
});
```

| 방식                               | 목적                                   | 단점                                                     | 장점                                                                 |
|------------------------------------|----------------------------------------|----------------------------------------------------------|----------------------------------------------------------------------|
| API 요청 핸들러 내부 분기 (if useMock) | 요청을 mock/real로 직접 나눔              | 모든 API마다 분기 코드가 들어감 → 코드가 더러워짐             | 제어가 확실함                                                          |
| axios-mock-adapter                | axios 요청 자체를 intercept해서 mock 사용 | mock 켜고 끄는 제어를 다른 파일에서 해야 함                  | API 코드 안에 분기 0개 → 컴포넌트/서비스 코드가 매우 깔끔함               |
